Name:          dnstapir-edm
# Replaced by makefile when building srpm
Version:       @@VERSION@@
Release:       1%{?dist}
Group:         dnstapir/edge
Summary:       DNS TAPIR Edge DNSTAP Minimiser
License:       BSD-2-Clause
URL:           https://www.github.com/dnstapir/edm
Source0:       %{name}.tar.gz
Source1:       dnstapir-edm.service
Source2:       well-known-domains.dawg
Source3:       ignored.dawg
Source4:       ignored-ips
BuildRequires: git
%if 0%{?suse_version}
BuildRequires: go
%if 0%{?suse_version} >= 1500
%ifarch x86_64 aarch64
BuildRequires: go-race
%endif
%endif
%else
BuildRequires: golang
%endif

%description
DNS TAPIR Edge DNSTAP Minimiser

# Disable building of debug packages for RHEL (we include symbols per default)
# ... also disable it for Fedora 42 and newer to fix builds
%if 0%{?rhel} >= 9 || 0%{?fedora} >= 42
%global debug_package %{nil}
%endif

%{!?_unitdir: %define _unitdir /usr/lib/systemd/system/}
%{!?_sysusersdir: %define _sysusersdir /usr/lib/sysusers.d/}
%{!?_localstatedir: %define _localstatedir /var}
%{!?_sharedstatedir: %define _sharedstatedir %{_localstatedir}/lib}

%prep
%setup -n %{name}

%build
make build

%install
mkdir -p %{buildroot}%{_bindir}
mkdir -p %{buildroot}%{_unitdir}
mkdir -p %{buildroot}%{_sysconfdir}/dnstapir/edm
mkdir -p %{buildroot}%{_sharedstatedir}/dnstapir/edm
mkdir -p %{buildroot}%{_sharedstatedir}/dnstapir/edm/pebble
mkdir -p %{buildroot}%{_sharedstatedir}/dnstapir/edm/mqtt

install -p -m 0755 %{name} %{buildroot}%{_bindir}/%{name}
install -m 0644 %{SOURCE1} %{buildroot}%{_unitdir}
install -m 0664 -D %{SOURCE2} %{buildroot}%{_sysconfdir}/dnstapir/edm/well-known-domains.dawg
install -m 0664 -D %{SOURCE3} %{buildroot}%{_sysconfdir}/dnstapir/edm/ignored.dawg
install -m 0664 -D %{SOURCE4} %{buildroot}%{_sysconfdir}/dnstapir/edm/ignored-ips

%files
%license LICENSE

%attr(0770,dnstapir-edm,dnstapir) %dir %{_sysconfdir}/dnstapir/edm
%attr(0770,dnstapir-edm,dnstapir) %dir %{_sharedstatedir}/dnstapir
%attr(0770,dnstapir-edm,dnstapir) %dir %{_sharedstatedir}/dnstapir/edm
%attr(0770,dnstapir-edm,dnstapir) %dir %{_sharedstatedir}/dnstapir/edm/pebble
%attr(0770,dnstapir-edm,dnstapir) %dir %{_sharedstatedir}/dnstapir/edm/mqtt

%attr(0755,dnstapir-edm,dnstapir) %{_bindir}/%{name}
%attr(0644,dnstapir-edm,dnstapir) %{_unitdir}/dnstapir-edm.service
%attr(0664,dnstapir-edm,dnstapir) %{_sysconfdir}/dnstapir/edm/well-known-domains.dawg
%attr(0664,dnstapir-edm,dnstapir) %{_sysconfdir}/dnstapir/edm/ignored.dawg
%attr(0664,dnstapir-edm,dnstapir) %{_sysconfdir}/dnstapir/edm/ignored-ips
%attr(0660,-,dnstapir) %ghost %{_sysconfdir}/dnstapir/dnstapir-edm.toml

%pre
/usr/bin/getent group dnstapir || /usr/sbin/groupadd -r dnstapir
/usr/bin/getent passwd dnstapir-edm || /usr/sbin/useradd -r -d /etc/dnstapir -G dnstapir -s /sbin/nologin dnstapir-edm

%post

%preun

%postun

%check

%changelog
